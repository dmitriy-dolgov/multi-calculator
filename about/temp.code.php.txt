<?php

//TODO: доделать
gl.functions.placesMap.prototype.showCourierP2P = function (coordFrom, coordTo) {

    // Примерно здесь остановился Apr.05.21 --- !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    var merchantLatLng = gl.functions.getCurrentGeoLocation();

    //$popup = 'Имя курьера<img src="/img/courier/4.gif" style="width:20px">';
    $popup = 'Курьер<img src="/img/courier/4.gif" style="width:20px">';

    //debugger;
    var mrkLanLng = false;
    debugger;
    if (this.markers) {
        for (var mId in this.markers) {
            mrkLanLng = this.markers[mId].marker.getLatLng();
            break;
        }
    }

    //Здесь создаются иконки для кратчайшего пути.
    /*var routerControl = L.Routing.control({
        waypoints: [
            L.latLng(merchantLatLng.lat, merchantLatLng.lng),
            L.latLng(mrkLanLng.lat, mrkLanLng.lng),
        ]
    }).addTo(this.map); //.bindPopup("Это описание курьера");

        var trtl = this.courierMarker;
        var trtlThis = this;

        routerControl.on('leafletDirectiveMap.drag', function (event, args) {

            var waypoints = e.waypoints || [];
            var destination = waypoints[waypoints.length - 1]; //

            //get the Leaflet map from the triggered event.
            var map = args.leafletEvent.target;
            var center = map.getCenter();

            //update(recenter) marker
            $scope.vm.markers.mainMarker.lat = center.lat;
            $scope.vm.markers.mainMarker.lng = center.lng;
        });

        // see https://stackoverflow.com/questions/34045265/destination-coordinates-in-leaflet-routing
        routerControl.on("routesfound", function (e) {
            debugger;
            console.log("coordinates:", coordinates);
            var destination = coordinates[coordinates.length - 1];
            console.log("coordinates 2:", coordinates);
            console.log("destination 2:", destination);
            console.log("coordinates.length:", coordinates.length);
            console.log("coordinates:", coordinates);
        });*/

    gl.functions.courierIconStart(coordinates);
};


//++++++++++++++++++++++++++++++++++++




//+++++++++++++++++++++++++

gl.functions.placesMap.prototype.showCourierByLatLng = function (merchantLatLng) {

    //customerLatLng
    var customerLatLng = gl.functions.getCurrentGeoLocation();
    debugger;
    var x = L.Routing.control({
        // YOUR STUFF
        //geocoder: L.Control.Geocoder.nominatim(),
        waypoints: [
            L.latLng(merchantLatLng.lat, merchantLatLng.lng),
            L.latLng(customerLatLng.lat, customerLatLng.lng),
        ]
    }).addTo(this.map);

    var waypoints = [];

    x.on("routesfound", function (e) {
        debugger;
        waypoints = e.waypoints || [];
        var destination = waypoints[waypoints.length - 1]; // there you have the destination point between your hands

        debugger;
        gl.functions.courierIconStart(waypoints);
    });

    return;

    //debugger;
    var customerLatLng = gl.functions.getCurrentGeoLocation();
    //companyLatLng

    //$popup = 'Имя курьера<img src="/img/courier/4.gif" style="width:20px">';
    $popup = 'Курьер<img src="/img/courier/4.gif" style="width:20px">';

    /*var buyerLanLng = false;
    debugger;
    if (this.markers && this.markers.length !== 0) {
        buyerLatLng = this.markers[0];
    } else {
        return false;
    }*/

    // Здесь создаются иконки для кратчайшего пути.
    var routerControl = L.Routing.control({
        waypoints: [
            L.latLng(merchantLatLng.lat, merchantLatLng.lng),
            L.latLng(customerLatLng.lat, customerLatLng.lng),
        ]
    }).addTo(this.map); //.bindPopup("Это описание курьера");

    /*var trtl = this.courierMarker;
    var trtlThis = this;

    routerControl.on('leafletDirectiveMap.drag', function (event, args) {

        //get the Leaflet map from the triggered event.
        var map = args.leafletEvent.target;
        var center = map.getCenter();

        //update(recenter) marker
        $scope.vm.markers.mainMarker.lat = center.lat;
        $scope.vm.markers.mainMarker.lng = center.lng;
    });*/

    routerControl.on("routesfound", function (e) {
        //debugger;
        console.log("coordinates:", coordinates);
        var destination = coordinates[coordinates.length - 1];
        console.log("coordinates 2:", coordinates);
        console.log("destination 2:", destination);
        console.log("coordinates.length:", coordinates.length);
        console.log("coordinates:", coordinates);
    });

    gl.functions.courierIconStart(coordinates);
};